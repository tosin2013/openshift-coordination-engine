name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run integration tests daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  GO_VERSION: "1.22"

jobs:
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Create kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: coordination-engine-test
          wait: 5m

      - name: Install ArgoCD
        run: |
          kubectl create namespace argocd
          kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
          kubectl wait --for=condition=available --timeout=300s deployment/argocd-server -n argocd

      - name: Run integration tests
        run: |
          make test-integration
        env:
          KUBECONFIG: ${{ env.HOME }}/.kube/config

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            test/integration/*.log
            coverage/integration-coverage.out
          retention-days: 7

  argocd-integration:
    name: ArgoCD Integration Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Create kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: argocd-test
          wait: 5m

      - name: Install ArgoCD
        run: |
          kubectl create namespace argocd
          kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
          kubectl wait --for=condition=available --timeout=300s deployment/argocd-server -n argocd

      - name: Test ArgoCD integration
        run: |
          if ls ./internal/integrations/argocd_*_test.go 1> /dev/null 2>&1; then
            go test -v -tags=integration -timeout=10m ./internal/integrations/argocd_*_test.go
          else
            echo "No ArgoCD integration tests found, skipping..."
          fi

  helm-integration:
    name: Helm Integration Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Create kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: helm-test
          wait: 5m

      - name: Test Helm integration
        run: |
          if ls ./internal/remediation/helm_*_test.go 1> /dev/null 2>&1; then
            go test -v -tags=integration -timeout=10m ./internal/remediation/helm_*_test.go
          else
            echo "No Helm integration tests found, skipping..."
          fi
